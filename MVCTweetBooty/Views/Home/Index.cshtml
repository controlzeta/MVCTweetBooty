@model MVCTweetBooty.Models.HomeModels
@{
    ViewBag.Title = "Tweet Search";
}
<div class="row" style="">
    <div class="col-md-8">
        <div class="panel panel-default">
            <div class="panel-body">
                <div class="col-md-6">
                    <p>@Model.rateLimit</p>
                </div>
                <div class="col-md-6">
                    <div class="col-md-6 bolder text-center">
                        Next Action<br />
                        <span id="minutes">00</span>:<span id="seconds">00</span>
                    </div>
                    <div class="col-md-6 bolder text-center">
                        <span id="minutes">
                            @Model.NumFotos</span> Photos<br />
                        <a class="btn btn-default"> Reload Photos</a>
</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="panel panel-default">
            <div class="panel-body">
                <div class="text-center bolder">Counters</div>
                <div class="col-md-4">
                    <div class="col-md-12 bolder text-center">
                        Tweets/RT's
                    </div>
                    <div class="col-md-12 text-center">
                         <span id="TweetCounter">@Model.TweetCounter</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="col-md-12 bolder text-center">
                        LOV
                    </div>
                    <div class="col-md-12 text-center">
                        <span id="FavCounter">@Model.FavCounter</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="col-md-12 bolder text-center">
                        Follow
                    </div>
                    <div class="col-md-12 text-center">
                        <span id="FollowCounter">@Model.FollowCounter</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<ul class="nav nav-tabs">
    <li role="presentation" class="active"><a data-toggle="tab" href="#tweetExplorer">Tweet Explorer</a></li>
    <li role="presentation"><a data-toggle="tab" href="#hashtagExplorer">Hashtag Explorer</a></li>
    <li role="presentation"><a data-toggle="tab" href="#tweetMentions">Tweet Mentions</a></li>
    <li role="presentation"><a data-toggle="tab" href="#messages">Tweet Something</a></li>
</ul>
<div class="row">
    <div class="tab-content">
        <div id="tweetExplorer" class="tab-pane fade in active">    <!-- Tweet Explorer -->
            <div style="min-height: 450px; padding-top: 15px;">
                <div class="col-lg-12">
                    <div class="row">
                        <div class="col-md-8 col-sm-12" style="padding-bottom:20px;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon" id="basic-addon1">Search</span>
                                        @Html.TextBoxFor(m => m.query, new { @class = "form-control", @placeholder = "Type your query" })
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    @Html.DropDownListFor(m => m.idResultNumber, new SelectList(Model.ResultsNumber, "Value", "Text"), new { @class = "form-control" })
                                </div>
                                <div class="col-md-2">
                                    @Html.DropDownListFor(m => m.idTypeOfResults, new SelectList(Model.TypeOfResults, "Value", "Text"), new { @class = "form-control" })
                                </div>
                                <div class="col-md-1">
                                    <a class="btn btn-primary" onclick="Search();">Search</a>
                                </div>
                                <div class="col-md-12 error">
                                    <span id="queryError"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-12" style="padding-bottom:20px;">
                            <div class="">
                                <div class="input-group">
                                    <span class="input-group-addon" id="basic-addon1">Hashtags</span>
                                    @Html.DropDownListFor(m => m.CountryId, new SelectList(Model.Countries, "Value", "Text"), new { @class = "form-control" })
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <table id="TweetsDT" style="width:100%" class="table-responsive table-bordered">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Tweet</th>
                                        <th>RT's</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-4">
                            <table id="HashtagsDT" style="width:100%" class="table-responsive table-bordered">
                                <thead>
                                    <tr>
                                        <th>Hashtag</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>                                                      <!-- Tweet Explorer -->
        <div id="hashtagExplorer" class="tab-pane fade">            <!-- Hashtag Explorer -->
            <div style="min-height: 450px; padding-top: 15px;">
                <h3>Menu 1</h3>
                <p>Some content in menu 1.</p>
            </div>  
        </div>                                                      <!-- Hashtag Explorer -->
        <div id="tweetMentions" class="tab-pane fade">              <!-- Tweet Mentions -->
            <div style="min-height: 450px; padding-top: 15px;">
                <div class="col-lg-12">
                    <div class="col-md-8">
                        <table id="MentionsDT" style="width:100%" class="table-responsive table-bordered">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Tweet</th>
                                    <th>RT's</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <table id="MentionsHashtag" style="width:100%" class="table-responsive table-bordered">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>                                                      <!-- Tweet Mentions -->
        <div id="messages" class="tab-pane fade">                   <!--    Messages    -->
            <div style="min-height: 450px; padding-top: 15px;">
                <div class="col-lg-12">
                    <div class="col-md-8">
                        <div class="row" style="padding-bottom:20px;">
                            <div class="col-md-10">
                                <div class="input-group">
                                    <span class="input-group-addon" id="basic-addon1">Tweet</span>
                                    @Html.TextBoxFor(m => m.TweetText, new { @class = "form-control", @placeholder = "Type something to Tweet" })
                                </div>
                            </div>
                            <div class="col-md-1">
                                <a class="btn btn-primary" onclick="Tweet();">Tweet!</a>
                            </div>
                            <div class="col-md-12 error">
                                <span id="tweetError"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <table id="TweetsDT" style="width:100%" class="table-responsive table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Username</th>
                                            <th>Tweet</th>
                                            <th>RT's</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>-</td>
                                            <td>-</td>
                                            <td>-</td>
                                            <td>-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="row" style="padding-bottom:20px;">
                            <div class="col-md-4">
                                <a class="btn btn-danger form-control">Schedule!</a>
                            </div>
                            <div class="col-md-4">
                                <a class="btn btn-info form-control">Add Media</a>
                            </div>
                            <div class="col-md-4">
                                <a class="btn btn-success form-control">Button!</a>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <table id="TweetsDT" style="width:100%" class="table-responsive table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>                                                      <!--    Messages    -->
    </div>
</div>
<script>
    var Tweets; var Hashtags;

    function Tweet() {
        $.ajax({
            //cache: false,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            url: "/Home/Tweet",
            data: "{ tweetText: '" + $('#TweetText').val() + "' }",
            success: function (data) {
                console.log(data);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.log(xhr.error);
                console.log(thrownError);
                console.log(ajaxOptions);
            }
        }); // end ajax call
    }

    function Search() {
        if ($('#query').val().length > 3) {
            console.log("{ query: '" + $('#query').val() + "' , " +
                " numberOfResults : " + $('#idResultNumber').val() + " , " +
                " resultsType : " + $('#idTypeOfResults').val() + " }");
            $.ajax({
                //cache: false,
                type: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                url: "/Home/SearchTweets",
                data: "{ query: '" + $('#query').val() + "' , " +
                " numberOfResults : '" + $('#idResultNumber').val() + "' , " +
                " resultsType : '" + $('#idTypeOfResults').val() + "' }",
                success: function (data) {
                    console.log(data);
                    $('#queryError').text('');
                    $('#TweetsDT').DataTable({
                        "sDom": '<"top"lf>rt<"bottom"p><"clear">',
                        "lengthMenu": [[25, 35, 50, -1], [25, 35, 50, "All"]],
                        "destroy": true,
                        "data": data.Statuses,
                        "columns": [
                            {
                                "data": "IdStr",
                                render: function (data, type, row) {
                                    return "<a href='https://twitter.com/" + row.Author.ScreenName + '/status/' + row.IdStr + "'  target='_blank' alt='" + row.IdStr + "'>" + row.IdStr.slice(0, 5) + "</a>";
                                }
                            },
                            {
                                "data": "Author.ScreenName",
                                render: function (data, type, row) {
                                    return "<a href='https://twitter.com/" + row.Author.ScreenName + "' target='_blank'>@@" + row.Author.ScreenName + "</a>";
                                }
                            },
                            { "data": "TextAsHtml" },
                            { "data": "RetweetCount" }
                        ]
                    });
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.error);
                    console.log(thrownError);
                    console.log(ajaxOptions);
                    alert("Ajax Failed!!!");
                }
            }); // end ajax call
        } else {
            $('#queryError').text('Write something to search! ');
        }
    }

    $(document).ready(function () {
        $("#CountryId").change(function () {
            var table = $('#HashtagsDT').DataTable();
            table.destroy();
            $('#HashtagsDT').empty();
            $.ajax({
                //cache: false,
                type: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                url: "/Home/GetHashtagByCountry",
                data: "{ id: " + $('#CountryId').val() + " }",
                success: function (data) {
                    Hashtags = data;
                    console.log(data);
                    $('#HashtagsDT').DataTable({
                        "sDom": '<"top"f>rt<"bottom"lp><"clear">',
                        "lengthMenu": [[25, 35, 50, -1], [25, 35, 50, "All"]],
                        "destroy": true,
                        "data": data,
                        "columns": [
                                { "data": "Name" },
								{ "data": "Url" }
                        ],
                        "columnDefs": [
						{
						    "title": "Hashtag",
						    "targets": 0,
						    "render": function (data, type, row) {
						        return '<a href="' + row["Url"] + '" target="_blank"> ' + data + '</a>';
						    }
						},
						{
						    "targets": 1,
						    "searchable": false,
						    "visible": false
						}]
                    });
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.error);
                    alert("Ajax Failed!!!");
                }
            }); // end ajax call
        });

        var minutesLabel = document.getElementById("minutes");
        var secondsLabel = document.getElementById("seconds");
        var totalSeconds = @Model.secondsLeft.ToString()
        setInterval(setTime, 1000);

        function setTime() {
            if (totalSeconds >= 1) {
                --totalSeconds;
                secondsLabel.innerHTML = pad(totalSeconds % 60);
                minutesLabel.innerHTML = pad(parseInt(totalSeconds / 60));
            } else {
                console.log('Tweeting');
                $.ajax({
                    //cache: false,
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: 'json',
                    url: "/Home/Timer",
                    data: "{ id: 0 }",
                    success: function (data) {
                        console.log(data);
                        totalSeconds = data;
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        console.log(xhr.error);
                        console.log(thrownError);
                        console.log(ajaxOptions);
                        alert("Ajax Failed!!!");
                    }
                }); // end ajax call
            }
        }

        function pad(val) {
            var valString = val + "";
            if (valString.length < 2) {
                return "0" + valString;
            }
            else {
                return valString;
            }
        }

        $('#query').keydown(function (event) {
            if (event.which == 13) {
                Search();
            }
        });
    });
</script>


